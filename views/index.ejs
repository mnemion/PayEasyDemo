<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <script src="https://js.tosspayments.com/v2/standard"></script>
</head>
<body>
<div class="container">
  <header>
    <h1><%= title %></h1>
    <p>ê°„ë‹¨í•œ ê²°ì œ API ì—°ë™ ë°ëª¨ ì• í”Œë¦¬ì¼€ì´ì…˜</p>
  </header>

  <main>
    <section class="payment-section">
      <h2>ìƒí’ˆ ê²°ì œ</h2>

      <div class="product-selection">
        <div class="product-card" data-product-id="1" data-product-price="10000" data-product-name="ê¸°ë³¸ ìƒí’ˆ">
          <h3>ê¸°ë³¸ ìƒí’ˆ</h3>
          <p class="product-price">10,000ì›</p>
          <button class="select-product-btn">ì„ íƒ</button>
        </div>

        <div class="product-card" data-product-id="2" data-product-price="20000" data-product-name="í”„ë¦¬ë¯¸ì—„ ìƒí’ˆ">
          <h3>í”„ë¦¬ë¯¸ì—„ ìƒí’ˆ</h3>
          <p class="product-price">20,000ì›</p>
          <button class="select-product-btn">ì„ íƒ</button>
        </div>

        <div class="product-card" data-product-id="3" data-product-price="50000" data-product-name="í”„ë¡œ ìƒí’ˆ">
          <h3>í”„ë¡œ ìƒí’ˆ</h3>
          <p class="product-price">50,000ì›</p>
          <button class="select-product-btn">ì„ íƒ</button>
        </div>
      </div>

      <div class="custom-payment">
        <h3>ë˜ëŠ” ì§ì ‘ ê¸ˆì•¡ ì…ë ¥</h3>
        <div class="input-group">
          <input type="number" id="custom-amount" min="1000" step="1000" placeholder="ê¸ˆì•¡ (ì›)">
          <button id="custom-amount-btn">ê²°ì œí•˜ê¸°</button>
        </div>
      </div>

      <div id="payment-form-container" class="hidden">
        <h3>ê²°ì œ ì •ë³´ ì…ë ¥</h3>
        <form id="payment-form">
          <div class="form-group">
            <label for="customer-name">ì´ë¦„</label>
            <input type="text" id="customer-name" required>
          </div>

          <div class="form-group">
            <label for="customer-email">ì´ë©”ì¼</label>
            <input type="email" id="customer-email" required>
          </div>

          <!-- í• ì¸ ì¿ í° -->
          <div class="form-group coupon-container">
            <div class="coupon-box">
              <input type="checkbox" id="coupon-box" />
              <label for="coupon-box">
                <div class="coupon-label">
                  <span class="coupon-icon">ğŸŸï¸</span>
                  <span class="coupon-text">5,000ì› í• ì¸ ì¿ í°</span>
                </div>
                <div class="coupon-description">ì²´í¬í•˜ë©´ ì¿ í°ì´ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤</div>
              </label>
            </div>
            <div id="discount-info" class="discount-info hidden">
              <div class="discount-details">
                <span>ì›ë˜ ê°€ê²©: <span id="original-price">0</span>ì›</span>
                <span>í• ì¸ ê¸ˆì•¡: <span class="discount-amount">5,000</span>ì›</span>
                <span>ìµœì¢… ê°€ê²©: <span id="final-price">0</span>ì›</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>ê²°ì œ ìˆ˜ë‹¨</label>
            <!-- ê²°ì œ ìœ„ì ¯ì´ ë“¤ì–´ê°ˆ ìë¦¬ -->
            <div id="payment-method"></div>
          </div>

          <!-- ì´ìš©ì•½ê´€ ìœ„ì ¯ -->
          <div class="form-group">
            <div id="agreement"></div>
          </div>

          <div class="payment-summary">
            <h4>ê²°ì œ ìš”ì•½</h4>
            <p>ìƒí’ˆ: <span id="product-name">ì„ íƒëœ ìƒí’ˆ</span></p>
            <p>ê¸ˆì•¡: <span id="payment-amount">0</span>ì›</p>
          </div>

          <div id="error-message" class="error-message" role="alert"></div>

          <button type="button" id="payment-button" class="button" disabled>
            <span id="button-text">ê²°ì œí•˜ê¸°</span>
            <div id="spinner" class="spinner hidden"></div>
          </button>
        </form>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 PayEasyDemo. ëª¨ë“  ê²°ì œëŠ” í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</p>
  </footer>
</div>

<script>
  document.addEventListener('DOMContentLoaded', main);

  async function main() {
    // ìƒí’ˆ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.querySelectorAll('.select-product-btn').forEach(button => {
      button.addEventListener('click', function() {
        const productCard = this.closest('.product-card');
        const productPrice = parseInt(productCard.dataset.productPrice);
        const productName = productCard.dataset.productName;

        // ê²°ì œ í¼ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
        updatePaymentForm(productName, productPrice);
      });
    });

    // ì»¤ìŠ¤í…€ ê¸ˆì•¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('custom-amount-btn').addEventListener('click', function() {
      const amountInput = document.getElementById('custom-amount');
      const amount = parseInt(amountInput.value);

      if (isNaN(amount) || amount < 1000) {
        alert('1,000ì› ì´ìƒì˜ ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ê²°ì œ í¼ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
      updatePaymentForm('ì»¤ìŠ¤í…€ ê²°ì œ', amount);
    });
  }

  // ê²°ì œ í¼ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
  async function updatePaymentForm(productName, amount) {
    // í™”ë©´ ì—…ë°ì´íŠ¸
    document.getElementById('product-name').textContent = productName;
    document.getElementById('payment-amount').textContent = amount.toLocaleString();
    document.getElementById('payment-form-container').classList.remove('hidden');

    const clientKey = '<%= tossPaymentsClientKey %>';
    const customerName = document.getElementById('customer-name');
    const customerEmail = document.getElementById('customer-email');
    const errorMessage = document.getElementById('error-message');
    const button = document.getElementById('payment-button');
    const coupon = document.getElementById('coupon-box');
    
    try {
      errorMessage.textContent = '';

      // ê²°ì œìœ„ì ¯ ì´ˆê¸°í™” 
      const tossPayments = TossPayments(clientKey);
      
      // ê³ ìœ í•œ ê³ ê° í‚¤ ìƒì„± (ë¹„íšŒì›)
      const customerKey = `ANON_${new Date().getTime()}`;
      const widgets = tossPayments.widgets({ customerKey });
      
      // ê²°ì œ ê¸ˆì•¡ ì„¤ì •
      await widgets.setAmount({
        currency: 'KRW',
        value: amount
      });

      // ê²°ì œ UIì™€ ì´ìš©ì•½ê´€ UI ë Œë”ë§
      await Promise.all([
        widgets.renderPaymentMethods({
          selector: '#payment-method',
          variantKey: 'DEFAULT'
        }),
        widgets.renderAgreement({
          selector: '#agreement',
          variantKey: 'AGREEMENT'
        })
      ]);

      // ë²„íŠ¼ í™œì„±í™”
      button.disabled = false;

      // ì¿ í° ì ìš© ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      coupon.addEventListener('change', async function() {
        try {
          const discountInfo = document.getElementById('discount-info');
          const originalPrice = document.getElementById('original-price');
          const finalPrice = document.getElementById('final-price');
          
          // ì›ë˜ ê°€ê²© í‘œì‹œ
          originalPrice.textContent = amount.toLocaleString();
          
          if (coupon.checked) {
            const discountedAmount = amount - 5000 > 0 ? amount - 5000 : 0;
            
            // í• ì¸ í›„ ê¸ˆì•¡ í‘œì‹œ
            finalPrice.textContent = discountedAmount.toLocaleString();
            
            // í• ì¸ ì •ë³´ í‘œì‹œ
            discountInfo.classList.remove('hidden');
            
            // ìœ„ì ¯ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
            await widgets.setAmount({
              currency: 'KRW',
              value: discountedAmount
            });
            
            // ê¸ˆì•¡ ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('payment-amount').textContent = `${discountedAmount.toLocaleString()} (5,000ì› í• ì¸ ì ìš©)`;
          } else {
            // í• ì¸ ì •ë³´ ìˆ¨ê¸°ê¸°
            discountInfo.classList.add('hidden');
            
            // ìœ„ì ¯ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
            await widgets.setAmount({
              currency: 'KRW',
              value: amount
            });
            
            // ê¸ˆì•¡ ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('payment-amount').textContent = amount.toLocaleString();
          }
          errorMessage.textContent = '';
        } catch (error) {
          errorMessage.textContent = `ì¿ í° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
        }
      });

      // ê²°ì œí•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      button.addEventListener('click', async function() {
        if (!customerName.value || !customerEmail.value) {
          errorMessage.textContent = 'ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
          return;
        }

        button.disabled = true;
        button.querySelector('#button-text').textContent = 'ê²°ì œ ì²˜ë¦¬ ì¤‘...';
        button.querySelector('#spinner').classList.remove('hidden');
        
        try {
          // ê³ ìœ í•œ ì£¼ë¬¸ë²ˆí˜¸ ìƒì„±
          const orderId = `order_${new Date().getTime()}_${Math.random().toString(36).substring(2, 8)}`;
          
          // ì¿ í° ì ìš© ê¸ˆì•¡ ê³„ì‚°
          const finalAmount = coupon.checked ? (amount - 5000 > 0 ? amount - 5000 : 0) : amount;
          
          // ê²°ì œ ìš”ì²­
          await widgets.requestPayment({
            orderId: orderId,
            orderName: productName,
            successUrl: `${window.location.origin}/payments/success`,
            failUrl: `${window.location.origin}/payments/fail`,
            customerEmail: customerEmail.value,
            customerName: customerName.value
          });
        } catch (error) {
          errorMessage.textContent = `ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
          button.disabled = false;
          button.querySelector('#button-text').textContent = 'ê²°ì œí•˜ê¸°';
          button.querySelector('#spinner').classList.add('hidden');
        }
      });
    } catch (error) {
      errorMessage.textContent = `ê²°ì œ ìœ„ì ¯ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
    }
  }
</script>
</body>
</html>